generator client {
	provider = "prisma-client-js"
}

datasource db {
	provider = "postgresql"
	url      = env("DATABASE_URL")
}

model User {
	id            String       @id @default(uuid())
	email         String       @unique
	passwordHash  String
	firstName     String
	lastName      String
	phone         String?
	role          UserRole
	ownerProfile  OwnerProfile?
	bookings      Booking[]
	notifications Notification[] @relation("NotificationRecipient")
	auditLogs     AuditLog[]     @relation("AuditActor")
	penaltiesIssued Penalty[]    @relation("PenaltyIssued")
	createdAt     DateTime       @default(now())
	updatedAt     DateTime       @updatedAt
}

model OwnerProfile {
	id              String     @id @default(uuid())
	user            User       @relation(fields: [userId], references: [id])
	userId          String     @unique
	companyName     String
	gstNumber       String?
	address         String?
	city            String?
	verifiedByAdmin Boolean    @default(false)
	buses           Bus[]
	bookings        Booking[]  @relation("OwnerBooking")
	penalties       Penalty[]
	createdAt       DateTime   @default(now())
	updatedAt       DateTime   @updatedAt
}

model Bus {
	id               String        @id @default(uuid())
	owner            OwnerProfile  @relation(fields: [ownerId], references: [id])
	ownerId          String
	title            String
	registrationNo   String        @unique
	capacity         Int
	description      String?
	imageUrl         String?
	amenities        String[]      @default([])
	active           Boolean       @default(true)
	approvalStatus   BusApprovalStatus @default(PENDING)
	approvalNote     String?
	media            BusMedia[]
	pricing          BusPrice?
	createdAt        DateTime      @default(now())
	updatedAt        DateTime      @updatedAt
	@@index([ownerId])
}

model BusMedia {
	id         String    @id @default(uuid())
	bus        Bus       @relation(fields: [busId], references: [id], onDelete: Cascade)
	busId      String
	fileName   String
	mimeType   String
	kind       MediaKind
	data       Bytes?
	url        String?
	createdAt  DateTime  @default(now())
	updatedAt  DateTime  @updatedAt

	@@index([busId, kind])
}

model Booking {
	id             String        @id @default(uuid())
	bus            Bus           @relation(fields: [busId], references: [id])
	busId          String
	owner          OwnerProfile  @relation("OwnerBooking", fields: [ownerId], references: [id])
	ownerId        String
	user           User          @relation(fields: [userId], references: [id])
	userId         String
	status         BookingStatus @default(QUOTE_REQUESTED)
	ownerPayoutPrice Decimal?    @db.Decimal(10, 2)
	userFinalPrice Decimal?      @db.Decimal(10, 2)
	ownerPayoutLockedAt DateTime?
	userPriceLockedAt DateTime?
	travelDetails  Json
	packageSelections Json?
	adminNotes     String?
	userNotes      String?
	ownerConfirmationAt DateTime?
	userConfirmationAt DateTime?
	payment        Payment?
	penalties      Penalty[]
	createdAt      DateTime      @default(now())
	updatedAt      DateTime      @updatedAt
	@@index([busId])
	@@index([ownerId])
	@@index([userId])
}

model BusPrice {
	id             String   @id @default(uuid())
	bus            Bus      @relation(fields: [busId], references: [id], onDelete: Cascade)
	busId          String   @unique
	expectedPrice  Decimal  @db.Decimal(10, 2)
	lastUpdatedAt  DateTime @default(now())
}

model Payment {
	id           String        @id @default(uuid())
	booking      Booking       @relation(fields: [bookingId], references: [id])
	bookingId    String        @unique
	amount       Decimal       @db.Decimal(10, 2)
	currency     String        @default("INR")
	status       PaymentStatus @default(INITIATED)
	provider     String?
	reference    String?
	processedAt  DateTime?
	createdAt    DateTime      @default(now())
	updatedAt    DateTime      @updatedAt
}

model Penalty {
	id          String       @id @default(uuid())
	booking     Booking      @relation(fields: [bookingId], references: [id])
	bookingId   String
	owner       OwnerProfile @relation(fields: [ownerId], references: [id])
	ownerId     String
	reason      String
	amount      Decimal       @db.Decimal(10, 2)
	issuedBy    User          @relation("PenaltyIssued", fields: [issuedById], references: [id])
	issuedById  String
	createdAt   DateTime      @default(now())
}

model Notification {
	id           String     @id @default(uuid())
	recipient    User       @relation("NotificationRecipient", fields: [recipientId], references: [id])
	recipientId  String
	type         NotificationType
	message      String
	metadata     Json?
	readAt       DateTime?
	createdAt    DateTime   @default(now())
}

model AuditLog {
	id          String   @id @default(uuid())
	actor       User?    @relation("AuditActor", fields: [actorId], references: [id])
	actorId     String?
	action      String
	entity      String
	entityId    String?
	payload     Json?
	createdAt   DateTime @default(now())
}

enum UserRole {
	ADMIN
	OWNER
	CUSTOMER
}

enum BookingStatus {
	QUOTE_REQUESTED
	ADMIN_REVIEWING
	PRICE_FINALIZED
	AWAITING_PAYMENT
	CONFIRMED
	CANCELLED
	COMPLETED
}

enum PaymentStatus {
	INITIATED
	SUCCESS
	FAILED
	REFUNDED
}

enum NotificationType {
	BOOKING_UPDATE
	BUS_UPDATE
	PENALTY
	SYSTEM
}

enum BusApprovalStatus {
	PENDING
	APPROVED
	REJECTED
}

enum MediaKind {
	IMAGE
	VIDEO
}
